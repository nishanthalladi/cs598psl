---
title: "proj2-dev"
author: "Ethan Cook"
date: "2023-11-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
library(tidyverse)
library(lubridate)
```


### Load train data
```{r}
# train_f1 = read.csv("Proj2_Data/fold_1/train.csv", stringsAsFactors = FALSE)
# train_f2 = read.csv("Proj2_Data/fold_2/train.csv", stringsAsFactors = FALSE)
# train_f3 = read.csv("Proj2_Data/fold_3/train.csv", stringsAsFactors = FALSE)
# train_f4 = read.csv("Proj2_Data/fold_4/train.csv", stringsAsFactors = FALSE)
# train_f5 = read.csv("Proj2_Data/fold_5/train.csv", stringsAsFactors = FALSE)
# train_f6 = read.csv("Proj2_Data/fold_6/train.csv", stringsAsFactors = FALSE)
# train_f7 = read.csv("Proj2_Data/fold_7/train.csv", stringsAsFactors = FALSE)
# train_f8 = read.csv("Proj2_Data/fold_8/train.csv", stringsAsFactors = FALSE)
# train_f9 = read.csv("Proj2_Data/fold_9/train.csv", stringsAsFactors = FALSE)
# train_f10 = read.csv("Proj2_Data/fold_10/train.csv", stringsAsFactors = FALSE)
# 
# train = train_f7 # TODO remove after testing
```

## Evaluate the accuracy
```{r}
myeval = function(){
  file_path = paste0('Proj2_Data/test_with_label.csv')
  test_with_label = read.csv(file_path)
  num_folds = 10
  wae = rep(0, num_folds)
  
  for (i in 1:num_folds) {
    file_path = paste0('Proj2_Data/fold_', i, '/test.csv')
    test = read.csv(file_path)
    test =  test %>%
      select(-IsHoliday) %>%
      left_join(test_with_label, by = c('Date', 'Store', 'Dept'))
    
    file_path = paste0('Proj2_Data/fold_', i, '/mypred.csv')
    test_pred = read.csv(file_path)
    
    actuals_and_predictions <- test %>%
      left_join(test_pred, by = c('Date', 'Store', 'Dept'))
    
    actuals = actuals_and_predictions$Weekly_Sales
    preds = actuals_and_predictions$Weekly_Pred
    weights = if_else(actuals_and_predictions$IsHoliday.x, 5, 1)
    wae[i] = sum(weights * abs(actuals - preds)) / sum(weights)
  }
  return(wae)
}
```

## Train data and generate predictions for test set
```{r}
train_and_pred = function(train, test)
{
  # find the unique pairs of (Store, Dept) combo that appeared in both training and test sets
  train_pairs = train[, 1:2] %>% count(Store, Dept) %>% filter(n != 0)
  test_pairs = test[, 1:2] %>% count(Store, Dept) %>% filter(n != 0)
  unique_pairs = intersect(train_pairs[, 1:2], test_pairs[, 1:2])
    
  # pick out the needed training samples, convert to dummy coding, then put them into a list
  train_split = unique_pairs %>% 
    left_join(train, by = c('Store', 'Dept')) %>% 
    mutate(Wk = factor(ifelse(year(Date) == 2010, week(Date) - 1, week(Date)), levels = 1:52)) %>%
    mutate(Yr = year(Date))
  
  test_split = unique_pairs %>% 
    left_join(test, by = c('Store', 'Dept')) %>% 
    mutate(Wk = factor(ifelse(year(Date) == 2010, week(Date) - 1, week(Date)), levels = 1:52)) %>%
    mutate(Yr = year(Date))
  
  # construct the design matrix only once
  train_split = as_tibble(model.matrix(~ Weekly_Sales + Store + Dept + Yr + Wk, train_split)) %>%
    group_split(Store, Dept)
  test_split = as_tibble(model.matrix(~ Store + Dept + Yr + Wk, test_split)) %>%
    mutate(Date = test_split$Date) %>% 
    group_split(Store, Dept)
  
  # pre-allocate a list to store the predictions
    test_pred = vector(mode = "list", length = nrow(unique_pairs))
  
  preds = c()
  # perform regression for each split, note we used lm.fit instead of lm
  for (i in 1:nrow(unique_pairs)) 
  {
    tmp_train = train_split[[i]]
    tmp_test = test_split[[i]]
      
    mycoef = lm.fit(as.matrix(tmp_train[, -(2:4)]), tmp_train$Weekly_Sales)$coefficients
    mycoef[is.na(mycoef)] = 0
    tmp_pred = mycoef[1] + as.matrix(tmp_test[, 4:55]) %*% mycoef[-1]
    preds = c(preds, tmp_pred)
  }
  as.data.frame(preds)
}
```

## Loop through every fold to train model and predict test set
```{r}
num_folds = 10
for (i in 1:num_folds) {
  print(paste0("Starting fold ", i))
  file_path = paste0('Proj2_Data/fold_', i, '/train.csv')
  train = read.csv(file_path)
  
  file_path = paste0('Proj2_Data/fold_', i, '/test.csv')
  test = read.csv(file_path)
  
  start_last_year = as.Date(min(test$Date)) - 375
  end_last_year = as.Date(max(test$Date)) - 350
  
  test_pred = train_and_pred(train, test)
  
  # test = cbind(test, Weekly_Pred = test_pred)
  test$Weekly_Pred = test_pred
  
  
  file_path = paste0('Proj2_Data/fold_', i, '/mypred.csv')
  readr::write_csv(test, file_path)
}
print(mean(myeval()))
```
```



